package com.predict_app.predictionservice.services.impl;

import com.predict_app.predictionservice.clients.CurrencyClient;
import com.predict_app.predictionservice.services.CurrencyConverterService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Slf4j
@RequiredArgsConstructor
@Service
public class CurrencyConverterServiceImpl implements CurrencyConverterService {

    private final CurrencyClient currencyClient;

    @Override
    public Double convertVndToUsd(Double vndAmount) {
        if (vndAmount == null || vndAmount <= 0) {
            log.warn("[PREDICTION] Invalid VND amount for conversion: {}", vndAmount);
            return 0.0;
        }

        try {
            Double exchangeRate = currencyClient.getUsdToVndRate();
            if (exchangeRate == null || exchangeRate <= 0) {
                log.error("[PREDICTION] Invalid exchange rate: {}", exchangeRate);
                return 0.0;
            }

            // Convert VND to USD: VND / rate * 1000 = USD (model expects values in *000USD)
            Double usdAmount = vndAmount / exchangeRate*1000;
            
            log.debug("[PREDICTION] Currency conversion - VND: {}, Rate: {}, USD: {}", 
                vndAmount, exchangeRate, usdAmount);
            
            return usdAmount;
        } catch (Exception e) {
            log.error("[PREDICTION] Error converting VND to USD: {}", e.getMessage(), e);
            return 0.0;
        }
    }
}

